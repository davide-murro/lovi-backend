<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <location path="." inheritInChildApplications="false">
    <system.webServer>

      <!-- Ensure ASP.NET Core Module runs your API -->
      <handlers>
        <add name="aspNetCore" path="api/*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
      </handlers>

      <aspNetCore processPath="dotnet" arguments=".\LoviBackend.dll" stdoutLogEnabled="false" hostingModel="inprocess" />

      <!-- Static file caching -->
      <staticContent>
        <clientCache cacheControlMode="UseMaxAge" cacheControlMaxAge="30.00:00:00" />
        <remove fileExtension=".json" />
        <mimeMap fileExtension=".json" mimeType="application/json" />
        <!-- Ensure correct MIME type for manifest -->
        <remove fileExtension=".webmanifest" />
        <mimeMap fileExtension=".webmanifest" mimeType="application/manifest+json" />

        <remove fileExtension=".js" />
        <mimeMap fileExtension=".js" mimeType="application/javascript" />
      </staticContent>

      <!-- SPA rewrite: send unknown requests to index.html -->
      <rewrite>
        <rules>
          <rule name="HTTP to HTTPS Redirect" stopProcessing="true">
            <match url="(.*)" />
            <conditions>
              <add input="{HTTPS}" pattern="off" />
            </conditions>
            <action type="Redirect" url="https://{HTTP_HOST}/{R:1}" redirectType="Permanent" />
          </rule>

          <rule name="Root to Default Path Redirect" stopProcessing="true">
            <match url="^$" />
            <action type="Redirect" url="/browser/en-US" redirectType="Permanent" />
          </rule>

          <!-- Redirect /browser (without locale) to default locale -->
          <rule name="Browser to Default Locale Redirect" stopProcessing="true">
            <match url="^browser/?$" />
            <action type="Redirect" url="/browser/en-US" redirectType="Permanent" />
          </rule>
          
          <rule name="Angular Routes" stopProcessing="true">
            <match url="^browser/([a-z]{2}-[A-Z]{2})/(.*)" />

            <!-- don't rewrite if file or folder exists -->
            <conditions logicalGrouping="MatchAll">
              <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
              <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
              <!-- don't rewrite API calls -->
              <add input="{REQUEST_URI}" pattern="^/api" negate="true" />
              <!-- Skip static files inside browser/en-US -->
              <add input="{REQUEST_URI}" pattern="(ngsw\.json|ngsw-worker\.js|manifest\.webmanifest|favicon\.ico|icons/|screenshots/)" negate="true" />
            </conditions>

            <!-- rewrite everything else to the localized index -->
            <action type="Rewrite" url="/browser/{R:1}/index.html" />
          </rule>
        </rules>
      </rewrite>
    </system.webServer>
  </location>
</configuration>
<!--ProjectGuid: 2d4509bb-4d8d-411e-8e0a-4a8f07b110d7-->