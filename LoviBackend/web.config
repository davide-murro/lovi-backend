<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <location path="." inheritInChildApplications="false">
    <system.webServer>

      <!-- Ensure ASP.NET Core Module runs your API -->
      <handlers>
        <add name="aspNetCore" path="api/*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
      </handlers>

      <aspNetCore processPath="dotnet" arguments=".\LoviBackend.dll" stdoutLogEnabled="false" hostingModel="inprocess" />

      <!-- Static file caching (optional but useful) -->
      <staticContent>
        <clientCache cacheControlMode="UseMaxAge" cacheControlMaxAge="30.00:00:00" />
        <remove fileExtension=".json" />
        <mimeMap fileExtension=".json" mimeType="application/json" />
      </staticContent>

      <!-- SPA rewrite: send unknown requests to index.html -->
      <rewrite>
        <rules>
          <rule name="HTTP to HTTPS Redirect" stopProcessing="true">
            <match url="(.*)" />
            <conditions>
              <add input="{HTTPS}" pattern="off" />
            </conditions>
            <action type="Redirect" url="https://{HTTP_HOST}/{R:1}" redirectType="Permanent" />
          </rule>

          <rule name="Non-WWW to WWW Redirect" stopProcessing="true">
            <match url="(.*)" />
            <conditions>
              <add input="{HTTP_HOST}" pattern="^lovi\.media$" />
            </conditions>
            <action type="Redirect" url="https://www.lovi.media/{R:1}" redirectType="Permanent" />
          </rule>

          <rule name="Root to Default Path Redirect" stopProcessing="true">
            <match url="^$" />
            <conditions>
              <add input="{HTTP_HOST}" pattern="^www\.lovi\.media$" />
            </conditions>
            <action type="Redirect" url="/browser/en-US" redirectType="Permanent" />
          </rule>
          
          <rule name="Angular Routes" stopProcessing="true">
            <match url=".*" />

            <!-- don't rewrite if file or folder exists -->
            <conditions logicalGrouping="MatchAll">
              <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
              <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
              <!-- don't rewrite API calls -->
              <add input="{REQUEST_URI}" pattern="^/api" negate="true" />
              <!-- allow direct access to the actual path and files -->
            </conditions>

            <!-- rewrite everything else to the localized index -->
            <action type="Rewrite" url="/browser/en-US/index.html" />
          </rule>
        </rules>
      </rewrite>
    </system.webServer>
  </location>
</configuration>
<!--ProjectGuid: 2d4509bb-4d8d-411e-8e0a-4a8f07b110d7-->